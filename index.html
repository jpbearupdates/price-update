<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Competitor Price Matrix</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- DataTables for sorting and filtering -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css">
    <style>
        body { font-size: 0.9rem; background-color: #f4f6f9; }
        .container-fluid { padding: 20px; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        table.dataTable thead th { background-color: #343a40; color: white; vertical-align: middle; }
        .price-cell { font-weight: bold; }
        .client-col { background-color: #e8f4ff !important; border-left: 2px solid #0d6efd; border-right: 2px solid #0d6efd; }
        
        /* ç‹€æ…‹æ¨™ç±¤ */
        .badge-stock { font-size: 0.7em; margin-left: 5px; }
        .oos { color: #dc3545; text-decoration: line-through; opacity: 0.6; }
        
        /* Action Column */
        .action-cell { font-weight: bold; text-align: center; }
        .action-red { background-color: #f8d7da !important; color: #842029; }
        .action-green { background-color: #d1e7dd !important; color: #0f5132; }
        .action-gray { color: #6c757d; }

        /* åƒ¹æ ¼æ¯”è¼ƒæ¨™ç¤º */
        .cheapest { color: #198754; position: relative; }
        .cheapest::after { content: 'ğŸ‘‘'; font-size: 0.8em; position: absolute; top: -5px; right: -10px; }
        .expensive { color: #dc3545; }
    </style>
</head>
<body>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="fw-bold">ğŸ›’ Market Matrix Monitor (100 SKU)</h3>
        <div class="text-end">
            <span class="badge bg-secondary" id="last-update">Loading...</span>
            <button class="btn btn-sm btn-primary ms-2" onclick="location.reload()">Refresh</button>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table id="matrixTable" class="table table-striped table-hover table-bordered" style="width:100%">
                    <thead>
                        <tr id="table-header">
                            <!-- JS will fill headers -->
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        <!-- JS will fill body -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>

<script>
    async function initDashboard() {
        try {
            const response = await fetch('dashboard_data.json');
            const json = await response.json();
            
            document.getElementById('last-update').innerText = "Updated: " + json.updated_at;
            
            const data = json.data;
            if (data.length === 0) return;

            // 1. å‹•æ…‹ç”Ÿæˆè¡¨é ­
            const headerRow = document.getElementById('table-header');
            headerRow.innerHTML = '<th>SKU Name</th>';
            
            // å–å¾—æ‰€æœ‰å¹³å°åç¨± (å‡è¨­ç¬¬ä¸€ç­†è³‡æ–™åŒ…å«æ‰€æœ‰å¹³å°)
            const platforms = data[0].platforms;
            platforms.forEach(p => {
                let thClass = p.role === 'client' ? 'client-col' : '';
                headerRow.innerHTML += `<th class="${thClass}">${p.name}</th>`;
            });
            headerRow.innerHTML += '<th>Action âš¡</th>';

            // 2. ç”Ÿæˆè¡¨æ ¼å…§å®¹
            const body = document.getElementById('table-body');
            
            data.forEach(row => {
                let tr = document.createElement('tr');
                
                // SKU Name
                let html = `<td class="fw-bold text-truncate" style="max-width: 200px;" title="${row.sku}">
                                <a href="#" class="text-decoration-none text-dark">${row.sku}</a>
                            </td>`;
                
                // æ‰¾å‡ºæœ€ä½åƒ¹ (ç”¨æ–¼æ¨™è¨˜)
                const prices = row.platforms.filter(p => p.price > 0).map(p => p.price);
                const minPrice = Math.min(...prices);

                // Platforms Data
                row.platforms.forEach(p => {
                    let cellClass = p.role === 'client' ? 'client-col text-center' : 'text-center';
                    let priceDisplay = p.price > 0 ? `$${p.price.toLocaleString()}` : '-';
                    
                    // åº«å­˜æ¨™è¨˜
                    let stockBadge = p.stock 
                        ? '<span class="badge bg-success badge-stock">In</span>' 
                        : '<span class="badge bg-danger badge-stock">OOS</span>';
                    
                    // åƒ¹æ ¼é¡è‰²é‚è¼¯
                    let priceClass = "price-cell";
                    if (!p.stock) priceClass += " oos";
                    if (p.price === minPrice && p.price > 0) priceClass += " cheapest";
                    
                    // é€£çµ
                    let link = p.url ? `<a href="${p.url}" target="_blank" class="text-decoration-none text-muted small">ğŸ”—</a>` : '';

                    html += `<td class="${cellClass}">
                                <div class="${priceClass}">${priceDisplay}</div>
                                <div>${stockBadge} ${link}</div>
                             </td>`;
                });

                // Action Column
                let actionClass = "action-cell";
                if (row.action_color === 'red') actionClass += " action-red";
                if (row.action_color === 'green') actionClass += " action-green";
                
                html += `<td class="${actionClass}">${row.action}</td>`;
                
                tr.innerHTML = html;
                body.appendChild(tr);
            });

            // 3. åˆå§‹åŒ– DataTable (æ’åºã€æœå°‹åŠŸèƒ½)
            $('#matrixTable').DataTable({
                "pageLength": 25,
                "order": [[ platforms.length + 1, "desc" ]] // é è¨­æŒ‰ Action æ’åº
            });

        } catch (e) {
            console.error(e);
            alert("Error loading data. Make sure dashboard_data.json exists.");
        }
    }

    initDashboard();
</script>

</body>
</html>
